/*
 * jPlayer Player Plugin for Popcorn JavaScript Library
 * http://www.jplayer.org
 *
 * Copyright (c) 2013 Happyworm Ltd
 * Licensed under the MIT license.
 * http://opensource.org/licenses/MIT
 *
 * Author: Mark J Panaghiston
 * Version: 1.1.1
 * Date: 5th June 2013
 *
 * For Popcorn Version: 1.3
 * For jPlayer Version: 2.4.0
 * Requires: jQuery 1.3.2+
 * Note: jQuery dependancy cannot be removed since jPlayer 2 is a jQuery plugin. Use of jQuery will be kept to a minimum.
 */

(function(e){var t="http://ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js",n="http://www.jplayer.org/2.4.0/js/jquery.jplayer.min.js",r="http://www.jplayer.org/2.4.0/js/Jplayer.swf",i="html,flash",s=!1,o=!1,u=!1,a={mp3:{codec:'audio/mpeg; codecs="mp3"',flashCanPlay:!0,media:"audio"},m4a:{codec:'audio/mp4; codecs="mp4a.40.2"',flashCanPlay:!0,media:"audio"},oga:{codec:'audio/ogg; codecs="vorbis"',flashCanPlay:!1,media:"audio"},wav:{codec:'audio/wav; codecs="1"',flashCanPlay:!1,media:"audio"},webma:{codec:'audio/webm; codecs="vorbis"',flashCanPlay:!1,media:"audio"},fla:{codec:"audio/x-flv",flashCanPlay:!0,media:"audio"},rtmpa:{codec:'audio/rtmp; codecs="rtmp"',flashCanPlay:!0,media:"audio"},m4v:{codec:'video/mp4; codecs="avc1.42E01E, mp4a.40.2"',flashCanPlay:!0,media:"video"},ogv:{codec:'video/ogg; codecs="theora, vorbis"',flashCanPlay:!1,media:"video"},webmv:{codec:'video/webm; codecs="vorbis, vp8"',flashCanPlay:!1,media:"video"},flv:{codec:"video/x-flv",flashCanPlay:!0,media:"video"},rtmpv:{codec:'video/rtmp; codecs="rtmp"',flashCanPlay:!0,media:"video"}},f=function(e){return e&&typeof e=="object"&&e.hasOwnProperty?!0:!1},l=function(e){var t=!1;return/\.mp3$/i.test(e)?t="mp3":/\.mp4$/i.test(e)||/\.m4v$/i.test(e)?t="m4v":/\.m4a$/i.test(e)?t="m4a":/\.ogg$/i.test(e)||/\.oga$/i.test(e)?t="oga":/\.ogv$/i.test(e)?t="ogv":/\.webm$/i.test(e)&&(t="webmv"),t},c=function(e){var t="",n="";if(f(e))for(var r in e)e.hasOwnProperty(r)&&(t+=n+r,n=",");return s&&console.log('getSupplied(): Generated: supplied = "'+t+'"'),t};e.player("jplayer",{_canPlayType:function(e,t){var n=e.toLowerCase(),r={media:{},options:{}},s=!1,o;if(n!=="video"&&n!=="audio"){typeof t=="string"?/^http.*/i.test(t)&&(o=l(t),o&&(r.media[o]=t,r.options.solution=i,r.options.supplied=o)):r=t;if(f(r)&&f(r.media)){f(r.options)||(r.options={}),r.options.solution||(r.options.solution=i),r.options.supplied||(r.options.supplied=c(r.media));var u=r.options.solution.toLowerCase().split(","),h=r.options.supplied.toLowerCase().split(",");for(var p=0;p<u.length;p++){var d=u[p].replace(/^\s+|\s+$/g,""),v=d==="html",m=d==="flash",g;for(var y=0;y<h.length;y++){o=h[y].replace(/^\s+|\s+$/g,"");if(a[o]){!g&&v&&(g=document.createElement(a[o].media));var b=!!(g&&g.canPlayType&&g.canPlayType(a[o].codec)),w=b&&v,E=a[o].flashCanPlay&&m;if(w||E)s={html:w,type:o},p=u.length,y=h.length}}}}}return s},_setup:function(){var a=this,h,p,d="unknown",v={},m={},g=!1,y=0,b=null,w=!1,E=null,S=function(){g?(s&&console.log("Dispatched event : durationchange : "+y),a.dispatchEvent("durationchange")):(s&&console.log("DELAYED EVENT (!ready) : durationchange : "+y),clearTimeout(b),b=setTimeout(S,250))},x=function(){var e=function(e){e.jPlayer.status.duration!==y&&(y=e.jPlayer.status.duration,S())},t=function(e){!w&&e.jPlayer.status.seekPercent===100&&(w=!0,setTimeout(function(){s&&console.log("Trigger : canplaythrough"),p._trigger($.jPlayer.event.canplaythrough)},0))};h.bind($.jPlayer.event.loadstart,function(){setTimeout(function(){s&&console.log("Trigger : loadeddata"),p._trigger($.jPlayer.event.loadeddata)},0)}).bind($.jPlayer.event.progress,function(n){e(n),t(n)}).bind($.jPlayer.event.timeupdate,function(n){e(n),t(n)}).bind($.jPlayer.event.play,function(){setTimeout(function(){s&&console.log("Trigger : playing"),p._trigger($.jPlayer.event.playing)},0)}),s&&console.log("Created CUSTOM event handlers for FLASH")},T=function(){(function(t){h=t("#"+a.id),typeof a.src=="string"?(d=l(a.src),v[d]=a.src,m.supplied=d,m.solution=i):f(a.src)&&(v=f(a.src.media)?a.src.media:{},m=f(a.src.options)?a.src.options:{},m.solution=m.solution||i,m.supplied=m.supplied||c(a.src.media)),m.swfPath=m.swfPath||r,h.bind(t.jPlayer.event.ready,function(e){e.jPlayer.flash.used&&x(),t(this).jPlayer("setMedia",v).jPlayer("load")});var n=t.jPlayer.reservedEvent+" loadeddata durationchange",o=n.split(/\s+/g),u=function(e){h.bind(t.jPlayer.event[e],function(t){s&&console.log("Dispatched event: "+e+(t&&t.jPlayer?" ("+t.jPlayer.status.currentTime+"s)":"")),a.dispatchEvent(e)}),s&&console.log("Created event handler for: "+e)};for(var b in t.jPlayer.event)if(t.jPlayer.event.hasOwnProperty(b)){var w=!0;for(var T in o)if(o.hasOwnProperty(T)&&o[T]===b){w=!1;break}w?u(b):s&&console.log("Skipped auto event handler creation for: "+b)}h.bind(t.jPlayer.event.loadeddata,function(e){s&&console.log("Dispatched event: loadeddata"+(e&&e.jPlayer?" ("+e.jPlayer.status.currentTime+"s)":"")),a.dispatchEvent("loadeddata"),g=!0}),s&&console.log("Created CUSTOM event handler for: loadeddata"),h.bind(t.jPlayer.event.durationchange,function(e){y=e.jPlayer.status.duration,S()}),s&&console.log("Created CUSTOM event handler for: durationchange"),h.bind(t.jPlayer.event.error,function(e){E=e.jPlayer.error,E.type===t.jPlayer.error.URL?E.code=4:E.code=0,s&&console.log("Dispatched event: error"),s&&console.dir(E),a.dispatchEvent("error")}),s&&console.log("Created CUSTOM event handler for: error"),e.player.defineProperty(a,"error",{set:function(){return E},get:function(){return E}}),e.player.defineProperty(a,"currentTime",{set:function(e){return p.status.paused?h.jPlayer("pause",e):h.jPlayer("play",e),e},get:function(){return p.status.currentTime}}),e.player.defineProperty(a,"duration",{set:function(){return g?y:NaN},get:function(){return g?y:NaN}}),e.player.defineProperty(a,"muted",{set:function(e){return h.jPlayer("mute",e),p.options.muted},get:function(){return p.options.muted}}),e.player.defineProperty(a,"volume",{set:function(e){return h.jPlayer("volume",e),p.options.volume},get:function(){return p.options.volume}}),e.player.defineProperty(a,"paused",{set:function(){return p.status.paused},get:function(){return p.status.paused}}),a.play=function(){h.jPlayer("play")},a.pause=function(){h.jPlayer("pause")},h.jPlayer(m),p=h.data("jPlayer")})(jQuery)},N=function(){jQuery.jPlayer?T():u?setTimeout(N,250):(u=!0,e.getScript(n,function(){u=!1,T()}))},C=function(){window.jQuery?N():o?setTimeout(C,250):(o=!0,e.getScript(t,function(){o=!1,N()}))};C()},_teardown:function(){jQuery("#"+this.id).jPlayer("destroy")}})})(Popcorn);